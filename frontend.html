<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FutureMakers –ñ–∞–ª–æ–±—ã</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      background: #f8fafc;
      color: #1f2937;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .tab {
      padding: 0.5rem 1rem;
      background: #e2e8f0;
      cursor: pointer;
      border-radius: 5px;
    }
    .tab.active {
      background: #3b82f6;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      table-layout: fixed;
    }
    th, td {
      padding: 0.6rem;
      border: 1px solid #e5e7eb;
      vertical-align: top;
      word-break: break-word;
    }
    th {
      background: #f1f5f9;
    }
    th.id-col, td.id-col {
      width: 40px;
      text-align: center;
    }
    th.content-col, td.content-col {
      width: 40%;
    }
    input, select, button {
      padding: 0.5rem;
      margin: 0.2rem 0;
      font-size: 1rem;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #2563eb;
    }
    .reply-wrapper {
      display: flex;
      margin-top: 0.5rem;
      gap: 0.5rem;
    }
    .reply-input {
      flex: 1;
      font-size: 0.9rem;
      padding: 0.4rem;
    }
    .send-button {
      font-size: 1.2rem;
      background: #10b981;
      padding: 0.3rem 0.6rem;
    }
    a {
      color: #2563eb;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>FutureMakers ‚Äî –ü–∞–Ω–µ–ª—å –∂–∞–ª–æ–±</h1>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('main')">üìã –û–±—Ä–∞—â–µ–Ω–∏—è</div>
    <div class="tab" onclick="switchTab('filter')">üîç –§–∏–ª—å—Ç—Ä –∏ –ø–æ–∏—Å–∫</div>
  </div>

  <div id="main" class="tab-content active">
    <form id="task-form">
      <input type="text" id="content" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∂–∞–ª–æ–±—ã" required />
      <input type="text" id="department" placeholder="–û—Ç–¥–µ–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
      <input type="datetime-local" id="deadline" required placeholder="–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú" />
      <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
    </form>

    <table>
      <thead>
        <tr>
          <th class="id-col">ID</th>
          <th class="content-col">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
          <th>–û—Ç–¥–µ–ª</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–°–æ–∑–¥–∞–Ω–æ</th>
          <th>–î–µ–¥–ª–∞–π–Ω</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody id="tasks"></tbody>
    </table>
  </div>

  <div id="filter" class="tab-content">
    <h2>üîé –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è</h2>
    <label>–û—Ç–¥–µ–ª:</label>
    <select id="filter-dept">
      <option value="">–í—Å–µ</option>
      <option value="–ñ–ö–•">–ñ–ö–•</option>
      <option value="–¶–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏—è">–¶–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏—è</option>
      <option value="–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —Å–ª—É–∂–±—ã">–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —Å–ª—É–∂–±—ã</option>
      <option value="–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞">–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞</option>
      <option value="–≠–∫–æ–ª–æ–≥–∏—è">–≠–∫–æ–ª–æ–≥–∏—è</option>
    </select>

    <label>–°—Ç–∞—Ç—É—Å:</label>
    <select id="filter-status">
      <option value="">–í—Å–µ</option>
      <option value="–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ">–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
      <option value="–≤—ã–ø–æ–ª–Ω–µ–Ω–∞">–≤—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
      <option value="–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞">–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</option>
    </select>

    <label>–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É:</label>
    <input type="text" id="search-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: FM-2025-0123" />
    <button onclick="applyFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>

    <table>
      <thead>
        <tr>
          <th class="id-col">ID</th>
          <th class="content-col">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
          <th>–û—Ç–¥–µ–ª</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody id="filter-results"></tbody>
    </table>
  </div>

  <script>
    const api = "http://localhost:8000";

    function switchTab(id) {
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
      document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add("active");
      document.getElementById(id).classList.add("active");
    }

    function parseHtmlContent(content) {
      const div = document.createElement("div");
      div.textContent = content;
      return div;
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${api}/tasks`);
        const tasks = await res.json();
        renderTasks(tasks, "tasks");
        window.allTasks = tasks;
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
        console.error(err);
      }
    }

    function renderTasks(tasks, containerId) {
      const tbody = document.getElementById(containerId);
      tbody.innerHTML = "";

      tasks.forEach(t => {
        const tr = document.createElement("tr");
        tr.id = `task-row-${t.id}`;
        const contentDiv = parseHtmlContent(t.content);
        let replySection = "";

        if (!t.reply && t.telegram_id && containerId === "tasks") {
          replySection = `
            <div class="reply-wrapper">
              <input class="reply-input" id="reply-${t.id}" placeholder="–û—Ç–≤–µ—Ç –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞..." />
              <button class="send-button" onclick="sendReply(${t.id})">‚û§</button>
            </div>
          `;
        } else if (t.reply) {
          replySection = `<p style="color:green; margin-top: 0.5rem;">üí¨ –û—Ç–≤–µ—Ç: ${t.reply}</p>`;
        }

        tr.innerHTML = `
          <td class="id-col">${t.id}</td>
          <td class="content-col">${contentDiv.innerHTML}${replySection}</td>
          <td>${t.department || "-"}</td>
          <td>
            <select id="status-${t.id}">
              <option ${t.status === '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ' ? 'selected' : ''}>–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
              <option ${t.status === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' ? 'selected' : ''}>–≤—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
              <option ${t.status === '–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞' ? 'selected' : ''}>–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞</option>
            </select>
          </td>
          <td>${t.created_at || ''}</td>
          <td>${t.deadline || ''}</td>
          <td>
            <button onclick="updateStatus(${t.id})">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="deleteComplaint(${t.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function sendReply(id) {
      const input = document.getElementById(`reply-${id}`);
      const message = input.value.trim();
      if (!message) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞");

      const res = await fetch(`${api}/tasks/${id}/reply`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reply: message })
      });

      if (res.ok) {
        alert("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
        loadTasks();
      } else {
        const err = await res.json();
        alert("–û—à–∏–±–∫–∞: " + err.detail);
      }
    }

    async function updateStatus(id) {
      const status = document.getElementById(`status-${id}`).value;
      const res = await fetch(`${api}/tasks/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });

      if (res.ok) {
        alert("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!");
        loadTasks();
      } else {
        const err = await res.json();
        alert("–û—à–∏–±–∫–∞: " + err.detail);
      }
    }

    async function deleteComplaint(taskId) {
      const res = await fetch(`${api}/tasks/${taskId}`, {
        method: 'DELETE'
      });
      if (res.status === 204) {
        document.getElementById(`task-row-${taskId}`).remove();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏");
      }
    }

    function applyFilter() {
      const dept = document.getElementById("filter-dept").value;
      const status = document.getElementById("filter-status").value;
      const idSearch = document.getElementById("search-id").value.trim().toLowerCase();
      const filtered = window.allTasks.filter(t => {
        return (!dept || t.department === dept) &&
               (!status || t.status === status) &&
               (!idSearch || String(t.id).toLowerCase().includes(idSearch));

      });
      renderTasks(filtered, "filter-results");
    }

    document.getElementById("task-form").addEventListener("submit", async e => {
      e.preventDefault();
      const content = document.getElementById("content").value.trim();
      const department = document.getElementById("department").value.trim();
      const deadline = document.getElementById("deadline").value;

      const res = await fetch(`${api}/tasks`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content, department, deadline })
      });

      if (res.ok) {
        alert("–ó–∞—è–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
        document.getElementById("task-form").reset();
        loadTasks();
      } else {
        const err = await res.json();
        alert("–û—à–∏–±–∫–∞: " + err.detail);
      }
    });

    loadTasks();
  </script>
</body>
</html>
